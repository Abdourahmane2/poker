<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Planning Poker - Jeu</title>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        padding: 20px;
        background-color: #f3f4f6;
        text-align: center;
        color: #333;
      }

      h1,
      h2,
      h3 {
        color: #4a90e2;
        margin-bottom: 15px;
      }

      .table-container,
      .card-container {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin: 20px 0;
      }

      .card {
        width: 70px;
        height: 100px;
        border-radius: 10px;
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        color: #4a90e2;
        transition: transform 0.2s ease, box-shadow 0.3s ease;
      }
      .card:hover {
        transform: translateY(-10px);
        background-color: #f0f4f8;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      }

      #but,
      #butt,
      #recommencer {
        display: none;
        margin-top: 20px;
        padding: 12px 24px;
        background-color: #4a90e2;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #but:hover,
      #butt:hover {
        background-color: #357abd;
      }

      .disabled-card {
        pointer-events: none;
        opacity: 0.6;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <h2>
      Fonctionnalité en cours:
      <span id="current-fonctionnalite">{{ current_fonctionnalite }}</span>
    </h2>
    <h3>
      Tour de jeu pour : <span id="current-joueur">{{ current_joueur }}</span>
    </h3>
    <div class="card-container" id="card-container">
      <div class="card" onclick="submitVote(1)">1</div>
      <div class="card" onclick="submitVote(2)">2</div>
      <div class="card" onclick="submitVote(3)">3</div>
      <div class="card" onclick="submitVote(5)">5</div>
      <div class="card" onclick="submitVote(8)">8</div>
      <div class="card" onclick="submitVote(13)">13</div>
      <div class="card" onclick="submitVote(21)">21</div>
      <div class="card" onclick="submitVote('Café')">Café</div>
    </div>

    <button id="but" onclick="afficher_vote()">Afficher les résultats</button>
    <button id="butt" onclick="passerALaFonctionnaliteSuivante()">
      Passer à la fonctionnalité suivante
    </button>
    <button id="recommencer" onclick="revenir_menu_principale()">
      menu principal
    </button>

    <script>
      function submitVote(value) {
        $.ajax({
          type: "POST",
          url: "{% url 'voter' %}",
          data: {
            button_value: value,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function (response) {
            $("#current-joueur").text(response.current_joueur);
            $("#current-fonctionnalite").text(response.current_fonctionnalite);

            if (response.cartes_bloquees) {
              $(".card").addClass("disabled-card");
              $("#but").show();
            }
            if (response.fini) {
              $("#butt").hide();
              alert("jeux termine");
            }
          },
          error: function (error) {
            console.error("Erreur lors de l'envoi du vote", error);
          },
        });
      }

      let tour = 1;
      let historiqueVotes = "";
      let currentFonctionnalite = "";

      function afficher_vote() {
        $.ajax({
          type: "GET",
          url: "{% url 'voter' %}",
          success: function (response) {
            // Vérifier si la fonctionnalité a changé
            if (response.current_fonctionnalite !== currentFonctionnalite) {
              currentFonctionnalite = response.current_fonctionnalite;
              historiqueVotes = ""; // Réinitialiser l'historique
              tour = 1; // Réinitialiser le numéro de tour
            }

            let message = `Fonctionnalité : ${response.current_fonctionnalite}\t Tour ${tour}:\n`;
            response.votes.forEach(function (vote, index) {
              message += `${vote.joueur} a voté : ${vote.valeur}\n`;
            });

            // Ajouter les votes du tour actuel à l'historique
            historiqueVotes += message + "---------------------\n";
            if(response.mode =="unanime") {
            if (response.bon) {
              alert(
                "Tous les joueurs ont voté de la même manière veuillez passer a la fonctionnalite suivante !\n\n" +
                  historiqueVotes
              );
              $(".card").addClass("disabled-card");
              $("#butt").show();
              if (response.fini) {
                $("#butt").hide();
                alert("Jeu terminé");
              }
            } else {
              alert(
                "Les votes ne sont pas unanimes, veuillez revoter.\n\n" +
                  historiqueVotes
              );
              $(".card").removeClass("disabled-card");
            } } else {
              alert( historiqueVotes + '\n moyenne des votes : ' + response.moyenne) 
              $("#butt").show();

            }

            // Mettre à jour les informations de l'interface
            $("#current-joueur").text(response.current_joueur);
            $("#current-fonctionnalite").text(response.current_fonctionnalite);

            // Mettre à jour et afficher le tour actuel
            $("#tour").text(`Tour ${tour}`);

            // Incrémenter le numéro de tour
            tour++;

            // Masquer le bouton d'action
            $("#but").hide();
          },
          error: function (error) {
            console.error("Erreur lors de l'affichage des votes", error);
          },
        });
      }

      function passerALaFonctionnaliteSuivante() {
        $(".card").removeClass("disabled-card");
        $.ajax({
            type: "POST",
            url: "{% url 'passer_a_la_suivante' %}",
            data: {
                csrfmiddlewaretoken: "{{ csrf_token }}",
            },
            success: function (response) {
                $("#current-fonctionnalite").text(response.current_fonctionnalite);
                $("#butt").hide();
    
                if (response.suivant) {
                    // Mettre à jour la fonctionnalité actuelle
                    $("#current-fonctionnalite").text(response.current_fonctionnalite);
                } else {
                    // Masquer le bouton s'il n'y a plus de fonctionnalités suivantes
                    $("#butt").hide();
                    $(".card").addClass("disabled-card");
    
                    alert("Jeu terminé, plus de fonctionnalités disponibles !\nUn fichier sera téléchargé contenant les résultats.");
    
                    // Lancer immédiatement le téléchargement du fichier JSON
                    const url = "/telecharger-donnees/";
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'votes.json';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
    
                    $("#current-fonctionnalite").text("");
                    $("#current-joueur").text("");
                    $("#recommencer").show();
                }
            },
            error: function (error) {
                console.error("Erreur lors du passage à la fonctionnalité suivante", error);
            },
        });
    }
    
      function revenir_menu_principale() {
        $.ajax({
          type: "POST",
          url: "{% url 'revenir_menu_principal' %}",
          data: {
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function () {
            location.href = "{% url 'revenir_menu_principal' %}";
          },

          error: function (error) {
            console.error("Erreur ", error);
          },
        });
      }
    </script>
  </body>
</html>
